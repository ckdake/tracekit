<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}tracekit{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    {% block extra_head %}{% endblock %}
</head>
<body>
{% include 'partials/_header.html' %}
{% block body %}{% endblock %}
<footer class="app-footer">
    &copy; 2026 tracekit
    <span class="footer-sep">&middot;</span>
    <a href="https://github.com/ckdake/tracekit" target="_blank" rel="noopener">GitHub</a>
    <span class="footer-sep">&middot;</span>
    Non-commercial use only &mdash; see <a href="https://github.com/ckdake/tracekit/blob/main/LICENSE.txt" target="_blank" rel="noopener">license</a>
    <span class="footer-sep">&middot;</span>
    <a href="/privacy">Privacy Policy</a>
    <span class="footer-sep">&middot;</span>
    <span class="footer-attribution">
        <a href="https://www.strava.com" target="_blank" rel="noopener" class="attr-strava" title="Powered by Strava">Powered by Strava</a>
        <span class="footer-sep">&middot;</span>
        <a href="https://www.garmin.com" target="_blank" rel="noopener" class="attr-garmin" title="Powered by Garmin">Powered by Garmin</a>
    </span>
</footer>
<script>
fetch('/api/recent-activity')
    .then(r => r.json())
    .then(d => {
        if (d.formatted) {
            const el = document.getElementById('recent-activity-time');
            if (el) el.textContent = d.formatted;
        }
    })
    .catch(() => {});
</script>
<script>
/* ── Notifications ──────────────────────────────────────────────── */
(function () {
    const bell    = document.getElementById('notif-bell');
    const badge   = document.getElementById('notif-badge');
    const dropdown = document.getElementById('notif-dropdown');
    const list    = document.getElementById('notif-list');
    const readAll = document.getElementById('notif-read-all');
    if (!bell) return;

    function relTime(ts) {
        const diff = Math.floor(Date.now() / 1000) - ts;
        if (diff < 60)  return 'just now';
        if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
        if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
        return Math.floor(diff / 86400) + 'd ago';
    }

    function renderList(notifications) {
        list.innerHTML = '';
        if (!notifications.length) {
            const li = document.createElement('li');
            li.className = 'notif-empty';
            li.textContent = 'No notifications';
            list.appendChild(li);
            return;
        }
        notifications.forEach(n => {
            const li = document.createElement('li');
            li.className = 'notif-item' + (n.read ? ' notif-read' : '') + (n.category === 'error' ? ' notif-error' : '');
            li.dataset.id = n.id;

            const msg = document.createElement('span');
            msg.className = 'notif-msg';
            msg.textContent = n.message;

            const meta = document.createElement('span');
            meta.className = 'notif-meta';
            meta.textContent = relTime(n.created);

            const actions = document.createElement('span');
            actions.className = 'notif-actions';

            if (!n.read) {
                const markBtn = document.createElement('button');
                markBtn.className = 'notif-btn';
                markBtn.title = 'Mark as read';
                markBtn.textContent = '✓';
                markBtn.addEventListener('click', e => { e.stopPropagation(); markRead(n.id); });
                actions.appendChild(markBtn);
            }

            const delBtn = document.createElement('button');
            delBtn.className = 'notif-btn notif-btn-del';
            delBtn.title = 'Delete';
            delBtn.textContent = '✕';
            delBtn.addEventListener('click', e => { e.stopPropagation(); deleteNotif(n.id); });
            actions.appendChild(delBtn);

            li.appendChild(msg);
            li.appendChild(meta);
            li.appendChild(actions);
            list.appendChild(li);
        });
    }

    function updateBadge(notifications) {
        const unread = notifications.filter(n => !n.read).length;
        if (unread > 0) {
            badge.textContent = unread > 99 ? '99+' : unread;
            badge.hidden = false;
        } else {
            badge.hidden = true;
        }
        bell.classList.toggle('notif-bell-has-unread', unread > 0);
    }

    let _cached = [];

    function loadNotifications() {
        fetch('/api/notifications')
            .then(r => r.json())
            .then(data => {
                _cached = Array.isArray(data) ? data : [];
                updateBadge(_cached);
                if (!dropdown.hidden) renderList(_cached);
            })
            .catch(() => {});
    }

    function markRead(id) {
        fetch(`/api/notifications/${id}/read`, { method: 'POST' })
            .then(() => loadNotifications())
            .catch(() => {});
    }

    function deleteNotif(id) {
        fetch(`/api/notifications/${id}`, { method: 'DELETE' })
            .then(() => loadNotifications())
            .catch(() => {});
    }

    readAll.addEventListener('click', () => {
        fetch('/api/notifications/read-all', { method: 'POST' })
            .then(() => loadNotifications())
            .catch(() => {});
    });

    bell.addEventListener('click', e => {
        e.stopPropagation();
        dropdown.hidden = !dropdown.hidden;
        if (!dropdown.hidden) renderList(_cached);
    });

    document.addEventListener('click', e => {
        if (!dropdown.hidden && !document.getElementById('notif-wrap').contains(e.target)) {
            dropdown.hidden = true;
        }
    });

    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') dropdown.hidden = true;
    });

    loadNotifications();
    setInterval(loadNotifications, 30000);
})();
</script>
</body>
</html>
