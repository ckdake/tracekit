{% extends "base.html" %}
{% block title %}tracekit — Admin{% endblock %}

{% block body %}
<div class="container-narrow">
    <div class="card">
        <h2>Users</h2>
        <p class="field-help">New signups are blocked by default. Toggle a user to active to allow them to log in.</p>
        <table class="admin-table">
            <thead>
                <tr>
                    <th>User</th>
                    <th>Status</th>
                    <th>Subscription</th>
                    <th>Providers &amp; Activities</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for u in user_data %}
                <tr id="user-row-{{ u.id }}">
                    <td class="admin-user-cell">
                        <span class="admin-user-id">#{{ u.id }}</span>
                        <span class="admin-user-email">{{ u.email }}</span>
                        {% if u.is_admin %}<span class="badge badge-auth" style="margin-left:6px">admin</span>{% endif %}
                    </td>
                    <td class="admin-status-cell">
                        {% if u.is_admin %}
                        <span class="admin-status-label active">active</span>
                        {% else %}
                        <label class="toggle" title="Toggle user access">
                            <input type="checkbox"
                                   {% if u.status == 'active' %}checked{% endif %}
                                   onchange="toggleUser({{ u.id }}, this)">
                            <span class="toggle-track"><span class="toggle-thumb"></span></span>
                        </label>
                        <span class="admin-status-label {{ u.status }}" id="status-label-{{ u.id }}">{{ u.status }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if u.subscription_status %}
                        <span class="admin-sub-chip {{ u.subscription_status }}">{{ u.subscription_status }}</span>
                        {% else %}
                        <span class="field-help" style="margin:0">—</span>
                        {% endif %}
                    </td>
                    <td class="admin-providers-cell">
                        {% set has_any = namespace(val=false) %}
                        {% for name, info in u.providers.items() %}
                            {% if info.enabled or info.count > 0 %}
                                {% set has_any.val = true %}
                                <span class="admin-provider-chip {% if info.enabled %}enabled{% endif %}">
                                    {{ name }}{% if info.count > 0 %}&nbsp;<span class="admin-provider-count">{{ info.count }}</span>{% endif %}
                                </span>
                            {% endif %}
                        {% endfor %}
                        {% if not has_any.val %}
                        <span class="field-help" style="margin:0">none</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if u.allow_impersonation and not u.is_admin %}
                        <button class="btn btn-sm btn-secondary" onclick="impersonateUser({{ u.id }})">Impersonate</button>
                        {% else %}
                        <span class="field-help" style="margin:0">—</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="card">
        <h2>Providers</h2>
        <p class="field-help">Enable or disable providers system-wide. Disabled providers are hidden from all users.</p>
        <div class="admin-providers-config">
            {% for name, enabled in system_providers.items() %}
            <div class="admin-provider-config-row">
                <label class="toggle" title="Toggle {{ name }} visibility">
                    <input type="checkbox"
                           id="provider-toggle-{{ name }}"
                           {% if enabled %}checked{% endif %}
                           onchange="toggleProvider('{{ name }}', this)">
                    <span class="toggle-track"><span class="toggle-thumb"></span></span>
                </label>
                <span class="admin-provider-config-name">{{ name }}</span>
                <span class="admin-provider-config-label {{ 'enabled' if enabled else 'disabled' }}"
                      id="provider-config-label-{{ name }}">{{ 'enabled' if enabled else 'disabled' }}</span>
            </div>
            {% endfor %}
        </div>

        <div class="admin-webhook-section">
            <h3>Strava Webhook Subscription</h3>
            <p class="field-help">
                Strava webhooks deliver real-time activity events (create, update, delete, deauthorize) to this
                application. Only one subscription exists per Strava app.
            </p>
            <div class="admin-webhook-row">
                <span class="admin-webhook-label">Status</span>
                <span id="webhook-status-badge"
                      class="admin-webhook-badge {% if strava_webhook_subscription_id %}active{% else %}inactive{% endif %}">
                    {% if strava_webhook_subscription_id %}
                        Active &mdash; ID {{ strava_webhook_subscription_id }}
                    {% else %}
                        No subscription
                    {% endif %}
                </span>
            </div>
            <div class="admin-webhook-actions">
                <button class="btn btn-sm btn-secondary" onclick="stravaWebhookSubscribe()"
                        {% if strava_webhook_subscription_id %}disabled{% endif %}
                        id="btn-webhook-subscribe">
                    Create Subscription
                </button>
                <button class="btn btn-sm btn-danger" onclick="stravaWebhookUnsubscribe()"
                        {% if not strava_webhook_subscription_id %}disabled{% endif %}
                        id="btn-webhook-unsubscribe">
                    Destroy Subscription
                </button>
            </div>
            <p id="webhook-error" class="field-help" style="color:#c0392b;display:none"></p>
        </div>
    </div>

    <div class="card card-danger">
        <h2>Sentry</h2>
        <p class="field-help">Trigger a test error to verify Sentry is receiving events.</p>
        <a href="/admin/sentry-test" class="btn btn-danger btn-sm">Trigger test error</a>
    </div>
</div>

<style>
.admin-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.95rem;
}
.admin-table th {
    text-align: left;
    padding: 8px 10px;
    border-bottom: 2px solid #e0e0e0;
    color: #666;
    font-weight: 600;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
}
.admin-table td {
    padding: 10px 10px;
    border-bottom: 1px solid #f0f0f0;
    vertical-align: middle;
}
.admin-table tr:last-child td { border-bottom: none; }
.admin-user-id { font-size: 0.78rem; color: #999; margin-right: 6px; }
.admin-user-email { font-weight: 500; }
.admin-status-cell { white-space: nowrap; display: flex; align-items: center; gap: 8px; padding-top: 14px; }
.admin-status-label { font-size: 0.82rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
.admin-status-label.active { color: #27ae60; }
.admin-status-label.blocked { color: #e74c3c; }
.admin-providers-cell { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }
.admin-provider-chip {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.78rem;
    background: #f0f0f0;
    color: #666;
    border: 1px solid #ddd;
}
.admin-provider-chip.enabled {
    background: #eaf6ef;
    color: #1e8449;
    border-color: #a9dfbf;
}
.admin-provider-count {
    background: rgba(0,0,0,0.1);
    border-radius: 8px;
    padding: 0 5px;
    font-size: 0.75rem;
    font-weight: 600;
}
.admin-sub-chip {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.78rem;
    font-weight: 600;
    background: #f0f0f0;
    color: #666;
    border: 1px solid #ddd;
    text-transform: uppercase;
    letter-spacing: 0.04em;
}
.admin-sub-chip.active {
    background: #eaf6ef;
    color: #1e8449;
    border-color: #a9dfbf;
}
.admin-sub-chip.past_due, .admin-sub-chip.unpaid {
    background: #fef9e7;
    color: #b7770d;
    border-color: #f9e79f;
}
.admin-sub-chip.canceled, .admin-sub-chip.incomplete_expired {
    background: #fdf2f2;
    color: #c0392b;
    border-color: #f5c6c6;
}
.admin-providers-config { display: flex; flex-direction: column; gap: 10px; margin-top: 8px; }
.admin-provider-config-row { display: flex; align-items: center; gap: 10px; }
.admin-provider-config-name { font-weight: 500; min-width: 100px; }
.admin-provider-config-label { font-size: 0.82rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
.admin-provider-config-label.enabled { color: #27ae60; }
.admin-provider-config-label.disabled { color: #999; }
.admin-webhook-section { margin-top: 24px; padding-top: 20px; border-top: 1px solid #e0e0e0; }
.admin-webhook-section h3 { font-size: 1rem; font-weight: 600; margin: 0 0 4px; }
.admin-webhook-row { display: flex; align-items: center; gap: 10px; margin: 12px 0 10px; }
.admin-webhook-label { font-size: 0.85rem; color: #666; min-width: 50px; }
.admin-webhook-badge { font-size: 0.82rem; font-weight: 600; padding: 2px 10px; border-radius: 12px; }
.admin-webhook-badge.active { background: #eaf6ef; color: #1e8449; border: 1px solid #a9dfbf; }
.admin-webhook-badge.inactive { background: #f5f5f5; color: #999; border: 1px solid #ddd; }
.admin-webhook-actions { display: flex; gap: 8px; flex-wrap: wrap; }
</style>

<script>
function impersonateUser(userId) {
    fetch('/admin/users/' + userId + '/impersonate', { method: 'POST' })
        .then(r => { if (r.redirected) window.location.href = r.url; });
}

function toggleProvider(provider, checkbox) {
    checkbox.disabled = true;
    fetch('/admin/providers/' + provider + '/toggle', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            const label = document.getElementById('provider-config-label-' + provider);
            if (data.enabled !== undefined) {
                checkbox.checked = data.enabled;
                if (label) {
                    label.textContent = data.enabled ? 'enabled' : 'disabled';
                    label.className = 'admin-provider-config-label ' + (data.enabled ? 'enabled' : 'disabled');
                }
            } else {
                checkbox.checked = !checkbox.checked;
            }
        })
        .catch(() => { checkbox.checked = !checkbox.checked; })
        .finally(() => { checkbox.disabled = false; });
}

function stravaWebhookSubscribe() {
    const btn = document.getElementById('btn-webhook-subscribe');
    const errEl = document.getElementById('webhook-error');
    btn.disabled = true;
    errEl.style.display = 'none';
    fetch('/admin/strava/webhook/subscribe', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                _setWebhookStatus(data.subscription_id);
            } else {
                errEl.textContent = data.error || 'Unknown error';
                errEl.style.display = '';
                btn.disabled = false;
            }
        })
        .catch(e => { errEl.textContent = String(e); errEl.style.display = ''; btn.disabled = false; });
}

function stravaWebhookUnsubscribe() {
    const btn = document.getElementById('btn-webhook-unsubscribe');
    const errEl = document.getElementById('webhook-error');
    btn.disabled = true;
    errEl.style.display = 'none';
    fetch('/admin/strava/webhook/unsubscribe', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                _setWebhookStatus(null);
            } else {
                errEl.textContent = data.error || 'Unknown error';
                errEl.style.display = '';
                btn.disabled = false;
            }
        })
        .catch(e => { errEl.textContent = String(e); errEl.style.display = ''; btn.disabled = false; });
}

function _setWebhookStatus(subId) {
    const badge = document.getElementById('webhook-status-badge');
    const subBtn = document.getElementById('btn-webhook-subscribe');
    const unsubBtn = document.getElementById('btn-webhook-unsubscribe');
    if (subId) {
        badge.textContent = 'Active \u2014 ID ' + subId;
        badge.className = 'admin-webhook-badge active';
        subBtn.disabled = true;
        unsubBtn.disabled = false;
    } else {
        badge.textContent = 'No subscription';
        badge.className = 'admin-webhook-badge inactive';
        subBtn.disabled = false;
        unsubBtn.disabled = true;
    }
}

function toggleUser(userId, checkbox) {
    const label = document.getElementById('status-label-' + userId);
    checkbox.disabled = true;
    fetch('/admin/users/' + userId + '/toggle', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.status) {
                const active = data.status === 'active';
                checkbox.checked = active;
                if (label) {
                    label.textContent = data.status;
                    label.className = 'admin-status-label ' + data.status;
                }
            } else {
                checkbox.checked = !checkbox.checked;
            }
        })
        .catch(() => { checkbox.checked = !checkbox.checked; })
        .finally(() => { checkbox.disabled = false; });
}
</script>
{% endblock %}
