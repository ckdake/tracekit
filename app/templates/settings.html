{% extends "base.html" %}
{% block title %}tracekit — Settings{% endblock %}

{% block body %}
<div class="container-narrow">
    <div class="card">
        <h2>General</h2>
        <div class="field-row">
            <label for="timezone">Home timezone</label>
            <select id="timezone">
                {% for tz in timezones %}
                <option value="{{ tz }}" {% if tz == config.home_timezone %}selected{% endif %}>{{ tz }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="field-row">
            <label class="toggle">
                <input type="checkbox" id="debug-toggle" {% if config.debug %}checked{% endif %}>
                <span class="toggle-track"><span class="toggle-thumb"></span></span>
                <span class="toggle-label">Debug mode</span>
            </label>
            <span class="field-help" style="margin: 0; flex: 1;">Enables verbose logging and detailed error output in the web app and CLI. Useful for troubleshooting sync issues.</span>
        </div>
        <div class="field-row">
            <label class="toggle">
                <input type="checkbox" id="allow-impersonation-toggle" {% if allow_impersonation %}checked{% endif %}>
                <span class="toggle-track"><span class="toggle-thumb"></span></span>
                <span class="toggle-label">Allow admin impersonation</span>
            </label>
            <span class="field-help" style="margin: 0; flex: 1;">When enabled, the site admin can browse the app as you for support purposes.</span>
        </div>
    </div>

    {% if stripe_enabled %}
    <div class="card">
        <h2>Subscription</h2>
        {% if subscription_status == 'active' %}
        <p class="field-help">
            Your subscription is <strong>active</strong>
            {% if subscription_end %}
             and renews on <strong>{{ subscription_end }}</strong>
            {% endif %}.
        </p>
        <div class="field-row">
            <button class="btn btn-secondary" id="stripe-portal-btn">Manage subscription</button>
        </div>
        {% else %}
        <p class="field-help">Subscribe to sync with providers. Cancel anytime.</p>
        <div class="field-row" style="gap: 0.75rem;">
            <button class="btn btn-primary" id="stripe-monthly-btn">Subscribe monthly</button>
            <button class="btn btn-primary" id="stripe-annual-btn">Subscribe annually</button>
        </div>
        {% if subscription_status and subscription_status != 'active' %}
        <p class="field-help" style="margin-top: 0.5rem;">Previous subscription status: <strong>{{ subscription_status }}</strong>.</p>
        {% endif %}
        {% endif %}
        <div id="stripe-error" class="modal-error" style="margin-top:0.5rem;"></div>
    </div>
    {% endif %}

    <div class="card">
        <h2>Providers</h2>
        <p class="drag-hint">drag to set priority order — the top provider has the highest priority.
            when multiple providers have data for the same activity, the highest-priority provider's values override the others.</p>
        <p class="field-help">
            <strong>enabled</strong> — enables pull and push for this provider.<br>
            <strong>sync equipment</strong> — when set, this provider will modify the equipment on matching activities; the highest-priority provider with data wins.<br>
            <strong>sync name</strong> — when set, this provider will modify the activity name; the highest-priority provider with data wins.
        </p>
        <div id="provider-list"></div>
    </div>
    <div class="card card-danger">
        <h2>Danger Zone</h2>
        <p class="field-help">Permanently delete this tracekit&rsquo;s copy of activities and sync records from the database. Files on disk are never touched. This cannot be undone.</p>
        <div class="danger-row">
            <span class="field-help" style="margin:0; flex-shrink:0">Reset a single provider:</span>
            <div id="provider-reset-list" class="danger-provider-btns"></div>
        </div>
        <div class="danger-row">
            <span class="field-help" style="margin:0; flex-shrink:0">Reset everything:</span>
            <button class="btn btn-danger" onclick="openResetAllModal()">Reset All Data</button>
        </div>
    </div>

</div>
<div id="status-msg"></div>

<!-- Reset All confirmation modal -->
<div id="reset-all-modal" class="modal-overlay hidden">
    <div class="modal-box">
        <h3>Reset All Data</h3>
        <p class="modal-subtitle">This will permanently delete <strong>all activities</strong> and sync records from the database. This cannot be undone.</p>
        <p class="field-help">Type <strong>reset</strong> to confirm:</p>
        <div class="modal-field">
            <input type="text" id="reset-confirm-input" placeholder="reset" autocomplete="off">
        </div>
        <div id="reset-modal-error" class="modal-error"></div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeResetAllModal()">Cancel</button>
            <button class="btn btn-danger" id="reset-confirm-btn" onclick="submitResetAll()">Reset All Data</button>
        </div>
    </div>
</div>

<!-- Reset Provider confirmation modal -->
<div id="reset-provider-modal" class="modal-overlay hidden">
    <div class="modal-box">
        <h3 id="reset-provider-title">Reset Provider</h3>
        <p class="modal-subtitle" id="reset-provider-subtitle"></p>
        <div id="reset-provider-error" class="modal-error"></div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeResetProviderModal()">Cancel</button>
            <button class="btn btn-danger" id="reset-provider-confirm-btn" onclick="submitResetProvider()">Reset</button>
        </div>
    </div>
</div>

<script>const INITIAL_CONFIG = {{ config | tojson }};
const SYSTEM_CREDENTIALS = {{ system_credentials | tojson }};
const ENABLED_PROVIDERS = {{ enabled_providers | tojson }};</script>
<script src="{{ url_for('static', filename='settings.js') }}"></script>
<script>
document.getElementById('allow-impersonation-toggle').addEventListener('change', function() {
    fetch('/api/user/allow-impersonation', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ enabled: this.checked }),
    });
});
</script>
{% if stripe_enabled %}
<script>
async function stripeAction(plan) {
    const errorEl = document.getElementById('stripe-error');
    errorEl.textContent = '';
    const endpoint = plan === 'portal' ? '/api/stripe/portal' : '/api/stripe/checkout';
    const body = plan === 'portal' ? {} : { plan };
    try {
        const resp = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
        });
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok) { errorEl.textContent = data.error || 'Something went wrong.'; return; }
        window.location.href = data.url;
    } catch (e) {
        errorEl.textContent = 'Network error: ' + e.message;
    }
}
document.getElementById('stripe-monthly-btn')?.addEventListener('click', () => stripeAction('monthly'));
document.getElementById('stripe-annual-btn')?.addEventListener('click', () => stripeAction('annual'));
document.getElementById('stripe-portal-btn')?.addEventListener('click', () => stripeAction('portal'));
</script>
{% endif %}
{% endblock %}
